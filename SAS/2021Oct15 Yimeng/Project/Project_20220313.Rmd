---
title: 'SARS-CoV-2 vaccine acceptance in Germany: Do trust in health care professionals make a difference?)'
author: "Zehui Bai"
output:
  html_document:
    df_print: paged
    number_sections: no
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
  md_document:
    toc: yes
  word_document:
    toc: yes
fontsize: 10pt
editor_options:
  chunk_output_type: console
colorlinks: yes
---

```{r setup, include=FALSE, echo = FALSE,message = FALSE, error = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE)

# load package
pkgs = c("ggcorrplot", "tidyverse","kableExtra", "sjPlot") 
inst = lapply(pkgs, library, character.only = TRUE) 

## 03.06 9:10-09.40
## 03.11 13:00-16:00, 20:30-21:10
## 03.12 3h
## 03.13 3h
```



 

# Data Exploration

## Fragesetllung

This project aims to explory the important factors to influence the 

Question 4/3: Wurden Sie gegen Corona geimpft? (ImpfZust)

## Selection of variables

Following variable are selected from the questionares:

* Perception of disease risk: 4/1; 4/2 (code)   
    + Question 4/1: Kennen Sie Personen, die an Corona erkrankt sind? (PersoKenn)
    + Question 4/2: Hatte mindestens eine dieser Personen einen schweren Krankheitsverlauf? (KennErkr)
* Attitude towards vaccination (ImpGrund):
    + Question 4/16: Warum haben/ wollen Sie sich gegen Corona impfen lassen? 
        + ImpGrund[beruf]	Ich habe/ möchte mich aus beruflichen Gründen impfen lassen
        + ImpGrund[risiko]	Ich möchte das Risiko einer Corona-Infektion verringern
        + ImpGrund[norm]	Ich möchte schnell zum normalen Leben zurückkehren
        + ImpGrund[gesfam]	Ich möchte die Gesundheit meiner Familie schützen
        + ImpGrund[sozum]	Ich werde/ wurde von meinem sozialen Umfeld angetrieben
        + ImpGrund[gesell]	Ich bin der Meinung, dass die Impfung einen wichtigen gesellschaftlichen Beitrag darstellt
        + ImpGrund[geswesent]	Ich bin der Meinung, dass die Impfung einen wichtigen gesellschaftlichen Beitrag darstellt
* One’s own health status: 
    + Question 2/2: Wie schätzen Sie Ihren allgemeinen körperlichen Gesundheitszustand im Durchschnitt über die letzten sechs Monate ein? (GesuZuK)
    + Question 2/3: Wie schätzen Sie Ihren allgemeinen psychischen Gesundheitszustand im Durchschnitt über die letzten sechs Monate ein? (GesuZuPsy)
    + Question 2/4: Welche der folgenden Impfungen haben Sie bereits erhalten? 
        + Anam[HepB]	Hepatitis B
        + Anam[Fern]	Impfungen für Fernreisen (wie z.B. Japanische Enzephalitis, Gelbfieber, Typhus, Tollwut)
        + Anam[Inf]	Influenza (mind. 1mal)
        + Anam[Mas]	Masern
        + Anam[Mum]	Mumps
        + Anam[Roet]	Röteln
        + Anam[Pol]	Polio (Kinderlähmung) 
        + Anam[Nicht]	Ich bin mir über meinen Impfstatus nicht sicher
        + Anam[Keine]	Ich habe keine der hier aufgelisteten Impfungen erhalten
* Socio-demographic data: 
    + Question 1/1: Bitte geben Sie Ihr Alter in Jahren an (Age)
    + Question 2/1: Welchem Geschlecht fühlen Sie sich zugehörig (Sex)
* Socio-economic status 
    + Question 8/1: Was ist Ihr höchster Schulabschluss (Schulab)
    + Question 8/2: Was ist Ihr höchster beruflicher Abschluss? (BerufAb) 
    + Question 8/3: Wie ist Ihr aktuelles Beschäftigungsverhältnis?
    + Question 8/4: Sind/ Waren Sie beruflich im Gesundheitswesen tätig? (TaetGes)
    + Question 8/5: In welchem Bereich sind/ waren Sie tätig? (TaetGesBer)
* Access to health information 
    + Question 6/5: Wie oft informieren Sie sich bewusst über Corona? (ZeitInfo)
* Trust in government 
    + Question 5/8: Wie zufrieden sind Sie mit der Arbeit der folgenden Einrichtungen während der Corona-Pandemie (in score transform)
* Compliance with health professionals 
    + Question 5/4: Wie schätzen Sie die Qualität der Behandlung dieses Arztes/dieser Ärztin im Allgemeinen ein? (zapaQualBe)
    + Question 5/5: Werden/Wurden Sie durch einen Arzt/eine Ärztin über die Corona Impfungen aufgeklärt? (zapaImpf)
    + Question 5/6: Haben sie aktiv nach einer Aufklärung gefragt? (AufklAkt)
    + Question 5/7: Waren Sie zufrieden mit der Aufklärung über die Impfung (ZufriedAufk)
* Internet and social media (convert the variable)
    + Question 6/4: Bitte geben Sie an, wie oft Sie mit den folgenden Personengruppen über Corona sprechen. (**not find**)
    
* Additional analysis
    + Question 4/5: Wie viele Corona-Impfungen haben Sie bis jetzt erhalten? (ImpDos)
    + Question 9/5: Wie viele Personen leben in Ihrem Haushalt (Sie mit eingeschlossen)? (PersHaus)
    + Question 6/2: Bitte geben Sie an, welche der nachfolgenden Informationsquellen Sie bei der Suche nach allgemeinen Informationen nutzen und wie häufig.
    + Question 6/4: Bitte geben Sie an, wie oft Sie mit den folgenden Personengruppen über Corona sprechen. (Face2Face[Fam],Face2Face[Fachpers]) 
    + Question 9/6: Wie hoch ist Ihr monatliches Nettoeinkommen? (Eink)
 
    
## Variable convertion

For the Question "Question 4/16: Warum haben/ wollen Sie sich gegen Corona impfen lassen?", the 7 sub questions will be regarded as seperate variables to explore the effects of different reason for vaccination.
  + ImpGrund[beruf]	Ich habe/ möchte mich aus beruflichen Gründen impfen lassen
  + ImpGrund[risiko]	Ich möchte das Risiko einer Corona-Infektion verringern
  + ImpGrund[norm]	Ich möchte schnell zum normalen Leben zurückkehren
  + ImpGrund[gesfam]	Ich möchte die Gesundheit meiner Familie schützen
  + ImpGrund[sozum]	Ich werde/ wurde von meinem sozialen Umfeld angetrieben
  + ImpGrund[gesell]	Ich bin der Meinung, dass die Impfung einen wichtigen gesellschaftlichen Beitrag darstellt
  + ImpGrund[geswesent]	Ich bin der Meinung, dass die Impfung einen wichtigen gesellschaftlichen Beitrag darstellt
        
For the Question "Question 2/4: Welche der folgenden Impfungen haben Sie bereits erhalten?", this Question will be converted to "Haben Sie andere Impfstoffe erhalten?" (ImpfHistory) If the participant has received any following vaccines (Check the following vaccine options), the answer of above question shoulb be "Ja".
    * Hepatitis B
    * Impfungen für Fernreisen (wie z.B. Japanische Enzephalitis, Gelbfieber, Typhus, Tollwut)
    * Influenza (mind. 1mal)
    * Masern
    * Mumps
    * Röteln
    * Polio (Kinderlähmung) 
Otherwise, the check of following two options will conclude "Nein" as answer.
    * Ich bin mir über meinen Impfstatus nicht sicher
    * Ich habe keine der hier aufgelisteten Impfungen erhalten

For the Question "Question 5/8: Wie zufrieden sind Sie mit der Arbeit der folgenden Einrichtungen während der Corona-Pandemie", the answer of following government agencies will not be analyzed as categorical variables, `GesuwiEin[Bund]`,`GesuwiEin[BuGe]`,`GesuwiEin[PolBund]`,`GesuwiEin[Gesu]`,`GesuwiEin[Pei]`,`GesuwiEin[Rki]`,`GesuwiEin[Stiko]`, but will be converted into scores. The correspondence between categories and scores is as follows 

* sehr zufrieden -- 50	
* eher zufrieden -- 25
* eher unzufrieden -- -25	
* sehr unzufrieden -- -50
* kann dazu nichts sagen -- 0

For each particicant, the mean score of the 7 government agencies will be calculated as the score of satisfaction with the government agency, which indicates the degree of trust in the government. (Govtrust)

 

For the Question "In welchem Bereich sind/ waren Sie tätig? (TaetGesBer)", This variable is transformed into a dichotomous variable, that is, does the participant's work in medical-related field, Ob der Teilnehmer in einem medizinnahen Bereich tätig ist (MediWork). Checking the following options is regarded as "Ja", that is, engaged in medical-related fields, 

* Medizinisches Personal
* Pharmazie
* Gesundheitsamt
* Krankenversicherung

otherwise the answer is "Nein".

 

```{r,echo = F,message = FALSE, error = FALSE, warning = FALSE}
library(readxl)
Project_full <- read_excel("C:/Users/zbai/Documents/GitHub/R-Projects/SAS/2021Oct15 Yimeng/Project/results-text.xlsx")
 
 
  
## select variables
Project1 <- subset(Project_full,
                   select = c(ImpfZust,ImpfMot,
                              PersoKenn,KennErkr,
                              `ImpGrund[beruf]`,`ImpGrund[risiko]`,`ImpGrund[norm]`,
                              `ImpGrund[gesfam]`,`ImpGrund[sozum]`,`ImpGrund[gesell]`,
                              `ImpGrund[geswesent]`,
                              GesuZuK,GesuZuPsy,`Anam[HepB]`,`Anam[Fern]`,
                              `Anam[Inf]`,`Anam[Mas]`,`Anam[Mum]`,`Anam[Roet]`,
                              `Anam[Pol]`,`Anam[Nicht]`,`Anam[Keine]`,
                              Sex, age,
                              Schulab, BerufAb, TaetGes, 
                              `TaetGesBer[1]`,`TaetGesBer[2]`,`TaetGesBer[3]`,
                              `TaetGesBer[4]`,`TaetGesBer[5]`,`TaetGesBer[other]`,
                              ZeitInfo,
                              `GesuwiEin[Bund]`,`GesuwiEin[BuGe]`,`GesuwiEin[PolBund]`,
                              `GesuwiEin[Gesu]`,`GesuwiEin[Pei]`,
                              `GesuwiEin[Rki]`,`GesuwiEin[Stiko]`,
                              zapaQualBe,	zapaImpf, AufklAkt, ZufriedAufk,
                              ImpDos,
                              `ErwerbStat[1]`,`ErwerbStat[2]`,`ErwerbStat[3]`,
                              `ErwerbStat[4]`,`ErwerbStat[5]`,`ErwerbStat[6]`,
                              `ErwerbStat[7]`,`ErwerbStat[8]`,`ErwerbStat[9]`,
                              `ErwerbStat[10]`,`ErwerbStat[11]`,`ErwerbStat[other]`,
                              PersHaus,
                              `InfoInt[Su]`,`InfoInt[Stell]`,`InfoInt[Vid]`,
                              `InfoInt[Pod]`,`InfoInt[TVrecht]`,`InfoInt[TVp]`,`InfoInt[Alt]`,
                              `InfoInt[Inst]`,`InfoInt[FB]`,`InfoInt[Twitt]`,`InfoInt[Snap]`,
                              `InfoInt[LinkX]`,`InfoInt[What]`,`InfoInt[Tel]`,`InfoInt[Ander]`,
                              `Face2Face[Fam]`,`Face2Face[Fachpers]`,
                              Eink))
 
# table(Project1$ImpfMot, Project1$ImpfZust)
# tabelcheck <- table(Project1$ImpfZust)
# tabelcheck

Project1 <- Project1 %>%
  mutate(ImpfZust = ifelse(ImpfMot=="Ja" | ImpfZust == "Ja" , "Ja", "Nein"))
# table(Project1$ImpfZust)

Project1$ImpfHistory <- ifelse(Project1$`Anam[HepB]`=="Ja"|Project1$`Anam[Fern]`=="Ja"|
                                 Project1$`Anam[Inf]`=="Ja"|Project1$`Anam[Mas]`=="Ja"|
                                 Project1$`Anam[Mum]`=="Ja"|Project1$`Anam[Roet]`=="Ja"|
                                 Project1$`Anam[Pol]`=="Ja","Ja",ifelse(Project1$`Anam[Nicht]`=="Ja"|Project1$`Anam[Keine]`=="Ja","Nein",NA))

Project1$MediWork <- ifelse(Project1$`TaetGesBer[1]`=="Ja"|Project1$`TaetGesBer[3]`=="Ja"|
                              Project1$`TaetGesBer[4]`=="Ja"|Project1$`TaetGesBer[5]`=="Ja", "Ja",
                            ifelse(Project1$`TaetGesBer[2]`=="Ja"|Project1$`TaetGesBer[other]`=="Ja","Nein",NA))


Project1$PersHausAlone <-  ifelse(Project1$PersHaus==1,"Alleine leben",
                                  ifelse(Project1$PersHaus>1,"Nicht alleine leben",NA))
 
FacFuna <- function(var){
  factor(var, levels = c("Ja", "Nein"), labels = c("Ja", "Nein"), exclude = NULL)
}
FacFunb <- function(var){
  factor(var, 
         levels = c("trifft nicht zu", "trifft eher nicht zu", 
                    "trifft eher zu", "trifft zu"), 
         labels = c("trifft nicht zu", "trifft eher nicht zu", 
                    "trifft eher zu", "trifft zu"))
}
FacFunc <- function(var){
  factor(var, 
         levels = c("Schlecht", "Weniger gut", "Gut", "Sehr gut"),
         labels = c("Schlecht", "Weniger gut", "Gut", "Sehr gut"))
}
FacFund <- function(var){
  factor(var, 
         levels = c("immer", "oft","nie", "selten"),
         labels = c("immer", "oft","nie", "selten"))
}




ScoreFun <- function(var){
  ifelse(var == "sehr unzufrieden", -50, ifelse(
    var == "eher unzufrieden", -25, ifelse(
      var == "kann dazu nichts sagen", 0, ifelse(
        var == "eher zufrieden", 25, ifelse(
          var == "sehr zufrieden", 50, NA
        )
      )
    )
  ))
}


## Score
Project1$Score_Bund <- ScoreFun(Project1$`GesuwiEin[Bund]`)
Project1$Score_BuGe <- ScoreFun(Project1$`GesuwiEin[BuGe]`)
Project1$Score_PolBund <- ScoreFun(Project1$`GesuwiEin[PolBund]`)
Project1$Score_Pei <- ScoreFun(Project1$`GesuwiEin[Pei]`)
Project1$Score_Gesu <- ScoreFun(Project1$`GesuwiEin[Gesu]`)
Project1$Score_Rki <- ScoreFun(Project1$`GesuwiEin[Rki]`) 
Project1$Score_Stiko <- ScoreFun(Project1$`GesuwiEin[Stiko]`)

## Replace the missing values with 0
Project1$Score_Bund[is.na(Project1$Score_Bund)] <- 0
Project1$Score_BuGe[is.na(Project1$Score_BuGe)] <- 0
Project1$Score_PolBund[is.na(Project1$Score_PolBund)] <- 0
Project1$Score_Pei[is.na(Project1$Score_Pei)] <- 0
Project1$Score_Gesu[is.na(Project1$Score_Gesu)] <- 0
Project1$Score_Rki[is.na(Project1$Score_Rki)] <- 0
Project1$Score_Stiko[is.na(Project1$Score_Stiko)] <- 0

Project1$Govtrust <- (Project1$Score_Bund + Project1$Score_BuGe + Project1$Score_PolBund + 
                        Project1$Score_Pei + Project1$Score_Rki + Project1$Score_Stiko + Project1$Score_Gesu)/7

### Format the variables 
Project1$Sex <- as.factor(Project1$Sex)
Project1$Schulab <- as.factor(Project1$Schulab)
Project1$BerufAb <- as.factor(Project1$BerufAb)
Project1$TaetGes <- as.factor(Project1$TaetGes)
Project1$ZeitInfo <- as.factor(Project1$ZeitInfo)
Project1$zapaQualBe <- as.factor(Project1$zapaQualBe)
Project1$ZufriedAufk <- as.factor(Project1$ZufriedAufk)
Project1$ImpDos <- as.factor(Project1$ImpDos)
Project1$PersHausAlone <- as.factor(Project1$PersHausAlone)

Project1$`Face2Face[Fam]` <- as.factor(Project1$`Face2Face[Fam]`)
Project1$`Face2Face[Fachpers]` <- as.factor(Project1$`Face2Face[Fachpers]`)
Project1$Eink <- as.factor(Project1$Eink)

Project1 <- Project1 %>%
  mutate(across(c(ImpfZust,PersoKenn,KennErkr,ImpfHistory,
                  MediWork, zapaImpf, AufklAkt,
                   `ErwerbStat[1]`,`ErwerbStat[2]`,`ErwerbStat[3]`,
                  `ErwerbStat[4]`,`ErwerbStat[5]`,`ErwerbStat[6]`,
                  `ErwerbStat[7]`,`ErwerbStat[8]`,`ErwerbStat[9]`,
                  `ErwerbStat[10]`,`ErwerbStat[11]`,`ErwerbStat[other]`),FacFuna))
# Project1$ImpfZust <- factor(Project1$ImpfZust, 
#                             levels = levels(addNA(Project1$ImpfZust)), 
#                             labels = c(levels(Project1$ImpfZust), "Missing"), 
#                             exclude = NULL)
  
Project1 <- Project1 %>%
  mutate(across(c(`ImpGrund[beruf]`,`ImpGrund[risiko]`,`ImpGrund[norm]`,
                  `ImpGrund[gesfam]`,`ImpGrund[sozum]`,`ImpGrund[gesell]`,
                  `ImpGrund[geswesent]`),FacFunb))

Project1 <- Project1 %>%
  mutate(across(c(GesuZuK, GesuZuPsy),FacFunc))

Project1 <- Project1 %>%
  mutate(across(c( `InfoInt[Su]`,`InfoInt[Stell]`,`InfoInt[Vid]`,
                   `InfoInt[Pod]`,`InfoInt[TVrecht]`,`InfoInt[TVp]`,`InfoInt[Alt]`,
                   `InfoInt[Inst]`,`InfoInt[FB]`,`InfoInt[Twitt]`,`InfoInt[Snap]`,
                   `InfoInt[LinkX]`,`InfoInt[What]`,`InfoInt[Tel]`,`InfoInt[Ander]`),FacFund))

Project2 <- subset(Project1, select = -c(`Anam[HepB]`,`Anam[Fern]`,`Anam[Inf]`,`Anam[Mas]`,
                                         `Anam[Mum]`,`Anam[Roet]`,`Anam[Pol]`,`Anam[Nicht]`,`Anam[Keine]`,
                                         `TaetGesBer[1]`,`TaetGesBer[2]`,`TaetGesBer[3]`,
                                         `TaetGesBer[4]`,`TaetGesBer[5]`,`TaetGesBer[other]`,
                                         `GesuwiEin[Bund]`,`GesuwiEin[BuGe]`,`GesuwiEin[PolBund]`,
                                         `GesuwiEin[Gesu]`,`GesuwiEin[Pei]`,`GesuwiEin[Rki]`,
                                         `GesuwiEin[Stiko]`,
                                         Score_Bund, Score_BuGe, Score_PolBund, 
                                         Score_Pei, Score_Gesu, Score_Rki, Score_Stiko))


## New Variable Abitur
Project2$Abitur=NULL
Project2$Abitur[Project2$Schulab=="Abitur/ Fachabitur"]="Ja"
Project2$Abitur[Project2$Schulab=="Hauptschulabschluss"]="Nein"
Project2$Abitur[Project2$Schulab=="Realschulabschluss"]="Nein"
Project2$Abitur[Project2$Schulab=="Sonstiges"]="Nein"
Project2$Abitur <- as.factor(Project2$Abitur)


## New variable Educational attainment, Employment status, Healthcare related job
## Monthly income, Household size
 

Project2 <- Project2 %>%
  mutate(Educational_attainment = case_when( BerufAb == "Keinen beruflichen Abschluss" ~ "No occupational degree",
                                             BerufAb == "Beruflich-betriebliche Ausbildung" ~ "Occupational training",
                                             BerufAb == "(Fach-)Hochschulabschluss (Bachelor/ Master, Diplom/ Magister)" ~ "University degree",
                                             BerufAb == "Hochschulabschluss (Promotion, Habilitation)" ~ "University degree",
                                             BerufAb == "Staatsexamen" ~ "University degree",
                                             BerufAb == "Sonstiges" ~ "Others"),
         Employment_status = `ErwerbStat[1]`,
         Healthcare_related_job = TaetGes,
         Monthly_income = case_when(
           Eink == "Unter 500€" ~ "<1.000",
           Eink == "500 bis unter 1.000€" ~ "<1.000",
           Eink == "1.000 bis unter 1.500€" ~ "1.000-2.000",
           Eink == "1.500 bis unter 2.000€" ~ "1.000-2.000",
           Eink == "2.000 bis unter 3.000€" ~ "2.000-4.000",
           Eink == "3.000 bis unter 4.000€" ~ "2.000-4.000",
           Eink == "4.000 bis unter 5.000€" ~ ">4.000",
           Eink == "5.000 bis unter 6.000€" ~ ">4.000",
           Eink == "6.000€ und mehr" ~ ">4.000"
         ),
         Household_size = PersHausAlone,
         quality_doctor_treantment = case_when(
           zapaQualBe == "Sehr hoch" ~ "Very high",
           zapaQualBe == "Eher hoch" ~ "Rather high",
           zapaQualBe == "Sehr gering" ~ "Rather/Very low",
           zapaQualBe == "Eher gering" ~ "Rather/Very low"
         ),
         Satisfaction_doctor_explanation = case_when(
           ZufriedAufk == "Sehr zufrieden" ~ "Very high",
           ZufriedAufk == "Eher zufrieden" ~ "Rather high",
           ZufriedAufk == "Sehr unzufrieden" ~ "Rather/Very low",
           ZufriedAufk == "Eher unzufrieden" ~ "Rather/Very low"
         ) )
 

## Change the outcome level
Project2$ImpfZust <- factor(Project2$ImpfZust, levels = c("Nein", "Ja"))
```
 
 
 
  
# Descriptive analyisis

```{r,echo = F,message = FALSE, error = FALSE, warning = FALSE}
## HTML Output
library(papeR)
Project_DecConti <- papeR::summarize(Project2, type = "numeric", group = "ImpfZust", show.NAs = T,digits.pval = 3, smallest.pval = 0.05)
rownames(Project_DecConti) <- NULL
kable(Project_DecConti, caption = "Descriptive statistics of continious variables", format = "html") %>% 
  kable_styling(latex_options = "striped")



 

## "BerufAb", "Eink"
Project_DecCate1 <- papeR::summarize(Project2 %>% dplyr::select(-BerufAb,-Eink), 
                                     type = "factor", 
                                     group = "ImpfZust", 
                                     smallest.pval = 0.05)
names(Project_DecCate1) <- c("Variable","Category","A",
                             "N (nicht geimpft)","% (nicht geimpft)","B",
                             "N (geimpft)","% (geimpft)","C",
                             "N (missing)","% (missing)","D","p.value")
Project_DecCate1 <- Project_DecCate1[-12]

 
Project_DecCate2 <- papeR::summarize(Project2 %>% dplyr::select(ImpfZust, BerufAb, Eink), 
                                     type = "factor", 
                                     group = "ImpfZust", 
                                     test = F,
                                     smallest.pval = 0.05)

names(Project_DecCate2) <- c("Variable","Category","A",
                             "N (nicht geimpft)","% (nicht geimpft)","B",
                             "N (geimpft)","% (geimpft)","C",
                             "N (missing)","% (missing)")
xtable <- table(Project2 %>%  dplyr::select(ImpfZust, BerufAb))
BerufAb_p <- fisher.test(xtable,simulate.p.value=TRUE)
BerufAb_p <- "<0.05"
Project_DecCate2$p.value <- BerufAb_p
Project_DecCate2$p.value[-1] <- ""



Project_DecCate <- rbind(Project_DecCate1, Project_DecCate2)
Project_DecCate <- Project_DecCate[-c(10:11)]

names(Project_DecCate) <- c("Variable","Category"," ",
                             "N (nicht geimpft)","% (nicht geimpft)"," ",
                             "N (geimpft)","% (geimpft)"," ","p.value")
rownames(Project_DecCate) <- NULL
kable(Project_DecCate, caption = "Descriptive statistics of categorical variables", format = "html") %>% 
  kable_styling(latex_options = "striped")
```


# Visualization
    
```{r,echo = F,message = FALSE, error = FALSE, warning = FALSE}
library("ggpubr")

 


P1 <- ggplot(data = Project2 %>% filter(ImpfZust != "")) +
  geom_histogram(mapping = aes(x = age, fill=ImpfZust),
                 binwidth = 2, col="black", size=.1)+
  scale_fill_discrete(name = "Vaccine Status") +
  labs(title="Variable: Age",
       x="Age (in years)",
       y="") +
  theme_set(theme_grey())+
  theme(legend.position="bottom")


P2 <- ggplot(data = Project2 %>% filter(ImpfZust != "") %>% filter(Sex != "" & Sex != "Divers" ),
             mapping = aes(x =Sex, fill =ImpfZust)) +
  # geom_bar(aes(y = (..count..)/sum(..count..)), width=.7, position = "dodge") +    
  # scale_y_continuous(labels = scales::percent) +
  geom_bar(width=.7, position = "dodge") +
  scale_fill_discrete(name = "Vaccine Status") +
  scale_x_discrete(labels=c("Männlich" = "Male", 
                            "Weiblich" = "Female")) +
  labs(title="Variable: Gender",
       x="Gender",
       y="") +
  theme_set(theme_grey())+
  theme(legend.position="bottom")
  
P3 <- ggplot(data = Project2 %>% filter(ImpfZust != "")  %>% filter(Abitur != "" ),
             mapping = aes(x =Abitur, fill =ImpfZust)) +
  # geom_bar(aes(y = (..count..)/sum(..count..)), width=.7, position = "dodge") +    
  # scale_y_continuous(labels = scales::percent) +
  geom_bar(width=.7, position = "dodge") +
  scale_fill_discrete(name = "Vaccine Status") +
  scale_x_discrete(labels=c("Ja" = "Yes", "Nein" = "No")) +
  labs(title="Variable: High school diploma",
       x="High school diploma",
       y="") +
  theme_set(theme_grey())+
  theme(legend.position="bottom")
  
P4 <- ggplot(data = Project2 %>% filter(ImpfZust != "")  %>% filter(Educational_attainment != "" ),
             mapping = aes(x =Educational_attainment, fill =ImpfZust)) +
  # geom_bar(aes(y = (..count..)/sum(..count..)), width=.7, position = "dodge") +    
  # scale_y_continuous(labels = scales::percent) +
  geom_bar(width=.7, position = "dodge") +
  scale_fill_discrete(name = "Vaccine Status") +
  scale_x_discrete(labels=c("No occupational degree" = "No OCCUP", 
                            "Occupational training" = "OCCUP training")) +
  labs(title="Variable: Educational attainment",
       x="Educational attainment",
       y="") +
  theme_set(theme_grey())+
  theme(legend.position="bottom")




P5 <- ggplot(data = Project2 %>% filter(ImpfZust != "")  %>% filter(Employment_status != "" ),
             mapping = aes(x =Employment_status, fill =ImpfZust)) +
  # geom_bar(aes(y = (..count..)/sum(..count..)), width=.7, position = "dodge") +    
  # scale_y_continuous(labels = scales::percent) +
  geom_bar(width=.7, position = "dodge") +
  scale_fill_discrete(name = "Vaccine Status") +
  scale_x_discrete(labels=c("Ja" = "Yes", "Nein" = "No")) +
  labs(title="Variable: Employment status",
       x="Employment status",
       y="") +
  theme_set(theme_grey())+
  theme(legend.position="bottom")


P6 <- ggplot(data = Project2 %>% filter(ImpfZust != "")  %>% filter(Healthcare_related_job != "" ),
             mapping = aes(x =Healthcare_related_job, fill =ImpfZust)) +
  # geom_bar(aes(y = (..count..)/sum(..count..)), width=.7, position = "dodge") +    
  # scale_y_continuous(labels = scales::percent) +
  geom_bar(width=.7, position = "dodge") +
  scale_fill_discrete(name = "Vaccine Status") +
  scale_x_discrete(labels=c("Ja" = "Yes", "Nein" = "No")) +
  labs(title="Variable: Healthcare related job",
       x="Healthcare related job",
       y="") +
  theme_set(theme_grey())+
  theme(legend.position="bottom")

 
P7 <- ggplot(data = Project2 %>% filter(ImpfZust != "")  %>% filter(Monthly_income != "" ),
             mapping = aes(x =Monthly_income, fill =ImpfZust)) +
  # geom_bar(aes(y = (..count..)/sum(..count..)), width=.7, position = "dodge") +    
  # scale_y_continuous(labels = scales::percent) +
  geom_bar(width=.7, position = "dodge") +
  scale_fill_discrete(name = "Vaccine Status") +
  labs(title="Variable: Monthly income",
       x="Monthly income (in €)",
       y="") +
  theme_set(theme_grey())+
  theme(legend.position="bottom")


P8 <- ggplot(data = Project2 %>% filter(ImpfZust != "")  %>% filter(Household_size != "" ),
             mapping = aes(x =Household_size, fill =ImpfZust)) +
  # geom_bar(aes(y = (..count..)/sum(..count..)), width=.7, position = "dodge") +    
  # scale_y_continuous(labels = scales::percent) +
  geom_bar(width=.7, position = "dodge") +
  scale_fill_discrete(name = "Vaccine Status") +
  scale_x_discrete(labels=c("Alleine leben" = "Live alone", 
                            "Nicht alleine leben" = "Not live alone")) +
  labs(title="Variable: Household size",
       x="Household size",
       y="") +
  theme_set(theme_grey())+
  theme(legend.position="bottom")


P9 <- ggplot(data = Project2 %>% filter(ImpfZust != "")  %>% filter(ImpfHistory != "" ),
             mapping = aes(x =ImpfHistory, fill =ImpfZust)) +
  # geom_bar(aes(y = (..count..)/sum(..count..)), width=.7, position = "dodge") +    
  # scale_y_continuous(labels = scales::percent) +
  geom_bar(width=.7, position = "dodge") +
  scale_fill_discrete(name = "Vaccine Status",labels = c("No", "Yes")) +
  scale_x_discrete(labels=c("Ja" = "Yes", "Nein" = "No")) +
  labs(title="Variable: Vaccination history",
       x="Vaccination history",
       y="") +
  theme_set(theme_grey())+
  theme(legend.position="bottom")

P10 <- ggplot(data = Project2 %>% filter(ImpfZust != "")  %>% filter(quality_doctor_treantment != "" ),
             mapping = aes(x =quality_doctor_treantment, fill =ImpfZust)) +
  # geom_bar(aes(y = (..count..)/sum(..count..)), width=.7, position = "dodge") +    
  # scale_y_continuous(labels = scales::percent) +
  geom_bar(width=.7, position = "dodge") +
  scale_fill_discrete(name = "Vaccine Status",labels = c("No", "Yes")) +
  labs(title="Variable: Quality of doctor´s treantment",
       x="Evaluation of the quality of doctor´s treantment",
       y="") +
  theme_set(theme_grey())+
  theme(legend.position="bottom")


P11 <- ggplot(data = Project2 %>% filter(ImpfZust != "")  %>% filter(zapaImpf != "" ),
             mapping = aes(x =zapaImpf, fill =ImpfZust)) +
  # geom_bar(aes(y = (..count..)/sum(..count..)), width=.7, position = "dodge") +    
  # scale_y_continuous(labels = scales::percent) +
  geom_bar(width=.7, position = "dodge") +
  scale_fill_discrete(name = "Vaccine Status",labels = c("No", "Yes")) +
  scale_x_discrete(labels=c("Ja" = "Yes", "Nein" = "No")) +
  labs(title="Variable: Detailed explanation of vaccine",
       x="Did doctor give a detailed explanation about vaccine",
       y="") +
  theme_set(theme_grey())+
  theme(legend.position="bottom")


P12 <- ggplot(data = Project2 %>% filter(ImpfZust != "")  %>% filter(Satisfaction_doctor_explanation != "" ),
             mapping = aes(x =Satisfaction_doctor_explanation, fill =ImpfZust)) +
  # geom_bar(aes(y = (..count..)/sum(..count..)), width=.7, position = "dodge") +    
  # scale_y_continuous(labels = scales::percent) +
  geom_bar(width=.7, position = "dodge") +
  scale_fill_discrete(name = "Vaccine Status",labels = c("No", "Yes")) +
  labs(title="Variable: Satisfaction with explanation",
       x="Satisfaction with the doctor´s explanation about vaccine",
       y="") +
  theme_set(theme_grey())+
  theme(legend.position="bottom")
 

P13 <- ggplot(data = Project2 %>% filter(ImpfZust != "")) +
  geom_histogram(mapping = aes(x = Govtrust, fill=ImpfZust),
                 binwidth = 2, col="black", size=.1)+
  scale_fill_discrete(name = "Vaccine Status",labels = c("No", "Yes")) +
  labs(title="Variable: Satisfaction scores",
       x="Satisfaction scores of national and official agencies",
       y="") +
  theme_set(theme_grey())+
  theme(legend.position="bottom") 


ggarrange(P1+ theme(legend.position="none"), 
          P2+ theme(legend.position="none"), 
          P3+ theme(legend.position="none"), 
          P4+ theme(legend.position="none"),
          P5+ theme(legend.position="none"),
          P6+ theme(legend.position="none"),
          P7+ theme(legend.position="none"),
          P8+ theme(legend.position="none"),
          labels = c("A", "B", "C", "D", "E", "F","G","H"),
          ncol = 2, nrow = 4) %>%
  annotate_figure( top = text_grob("Histogram/Bar chart to explore investifated variables", face = "bold", size = 12))


ggarrange(P9, P10, P11, P12, P13,
          common.legend = TRUE,
          legend="bottom",
          labels = c("I", "J", "K", "L", "M"),
          ncol = 2, nrow = 3)


```
 
 
 
 

# Modeling 

## Univariable Regression

```{r,echo = F,message = FALSE, error = FALSE, warning = FALSE}
Project_model <- Project2 %>% 
  dplyr::select(ImpfZust, age, Sex, Abitur, Educational_attainment, Employment_status,
         Healthcare_related_job, Monthly_income,  Household_size, ImpfHistory,
         quality_doctor_treantment, zapaImpf, Satisfaction_doctor_explanation, Govtrust) %>%
  filter(ImpfZust != "")

Project_model$Educational_attainment <- as.factor(Project_model$Educational_attainment) 
Project_model$Monthly_income <- as.factor(Project_model$Monthly_income) 
Project_model$quality_doctor_treantment <- as.factor(Project_model$quality_doctor_treantment) 
Project_model$Satisfaction_doctor_explanation <- as.factor(Project_model$Satisfaction_doctor_explanation) 

 

Project_DecCate2 <- papeR::summarize(Project_model, 
                                     type = "factor", 
                                     group = "ImpfZust", 
                                     test = F,
                                     smallest.pval = 0.05)
Project_DecCate2 %>% kable(caption = "Descriptive statistics of selected variables for modeling", format = "html") %>%
  kable_styling(latex_options = "striped")
names(Project2)




 

Unimodel.age <- glm(ImpfZust ~ age, data = Project_model, family=binomial())
tab_model(Unimodel.age, title="Univariate logistic regression for age" )

 
## relevel
Project_model$Sex <- relevel(Project_model$Sex, ref = "Männlich")
Unimodel.Sex <- glm(ImpfZust ~ Sex, data = Project_model %>% filter(Sex == "Männlich"|Sex == "Weiblich"), family=binomial())
tab_model(Unimodel.Sex, title="Univariate logistic regression for Sex" )

# Same results
# Unimodel.Sex <- glm(ImpfZust ~ Sex, data = Project_model, family=binomial())
# tab_model(Unimodel.Sex, title="Univariate logistic regression for Sex" )



Project_model$Abitur <- relevel(Project_model$Abitur, ref = "Nein")
Unimodel.Abitur <- glm(ImpfZust ~ Abitur, data = Project_model, family=binomial())
tab_model(Unimodel.Abitur, title="Univariate logistic regression for Abitur" )


Unimodel.Educational_attainment <- glm(ImpfZust ~ Educational_attainment, data = Project_model, family=binomial())
tab_model(Unimodel.Educational_attainment, title="Univariate logistic regression for Educational attainment" )




Project_model$Employment_status <- relevel(Project_model$Employment_status, ref = "Nein")
Unimodel.Employment_status <- glm(ImpfZust ~ Employment_status , data = Project_model, family=binomial())
tab_model(Unimodel.Employment_status  , title="Univariate logistic regression for Employment status" )


Project_model$Healthcare_related_job <- relevel(Project_model$Healthcare_related_job, ref = "Nein")
Unimodel.Healthcare_related_job <- glm(ImpfZust ~ Healthcare_related_job, data = Project_model, family=binomial())
tab_model(Unimodel.Healthcare_related_job   , title="Univariate logistic regression for Healthcare_related_job" )



Unimodel.Monthly_income <- glm(ImpfZust ~ Monthly_income, data = Project_model, family=binomial())
tab_model(Unimodel.Monthly_income   , title="Univariate logistic regression for Monthly_income" )


Unimodel.Household_size <- glm(ImpfZust ~ Household_size, data = Project_model, family=binomial())
tab_model(Unimodel.Household_size   , title="Univariate logistic regression for Household_size" )


Project_model$ImpfHistory <- relevel(Project_model$ImpfHistory, ref = "Nein")
Unimodel.ImpfHistory <- glm(ImpfZust ~ ImpfHistory, data = Project_model, family=binomial())
tab_model(Unimodel.ImpfHistory   , title="Univariate logistic regression for ImpfHistory" )


Project_model$quality_doctor_treantment <- as.factor(Project_model$quality_doctor_treantment)
Project_model$quality_doctor_treantment <- relevel(Project_model$quality_doctor_treantment, ref = "Rather/Very low")
Unimodel.quality_doctor_treantment <- glm(ImpfZust ~ quality_doctor_treantment, data = Project_model, family=binomial())
tab_model(Unimodel.quality_doctor_treantment   , title="Univariate logistic regression for Evaluation of the quality of doctor treantment " )


Project_model$zapaImpf <- relevel(Project_model$zapaImpf, ref = "Nein")
Unimodel.zapaImpf <- glm(ImpfZust ~ zapaImpf, data = Project_model, family=binomial())
tab_model(Unimodel.zapaImpf   , title="Univariate logistic regression for Did the doctor give a detailed explanation about the corona vaccine" )



Project_model$Satisfaction_doctor_explanation <-  as.factor(Project_model$Satisfaction_doctor_explanation)
Project_model$Satisfaction_doctor_explanation <- relevel(Project_model$Satisfaction_doctor_explanation, ref = "Rather/Very low")
Unimodel.Satisfaction_doctor_explanation <- glm(ImpfZust ~ Satisfaction_doctor_explanation, data = Project_model, family=binomial())
tab_model(Unimodel.Satisfaction_doctor_explanation   , title="Univariate logistic regression for Satisfaction with the doctor explanation about vaccine " )


 
  
Unimodel.Govtrust <- glm(ImpfZust ~ Govtrust, data = Project_model, family=binomial())
tab_model(Unimodel.Govtrust   , title="Univariate logistic regression for" )


```






## Full model

```{r,echo = F,message = FALSE, error = FALSE, warning = FALSE}


## fit full model
Model.full <- glm(ImpfZust ~ age + Abitur + Educational_attainment + Monthly_income + ImpfHistory + quality_doctor_treantment  + Govtrust + zapaImpf,data = Project_model, family=binomial())
str(Project_model)
## the higher the value of VIF and the higher the multicollinearity with the particular independent variable.
## VIF exceeding 5 or 10 indicates high multicollinearity between this independent variable and the others
performance::check_collinearity(Model.full)
tab_model(Model.full)


Project_model <- Project_model %>% dplyr::select(-Satisfaction_doctor_explanation)
```


## PMM imputation

```{r,echo = F,message = FALSE, error = FALSE, warning = FALSE}
## Predictive Mean Matching (PMM) is a semi-parametric imputation approach. It is similar to the regression method except that for each missing value, it fills in a value randomly from among the a observed donor values from an observation whose regression-predicted values are closest to the regression-predicted value for the missing value from the simulated regression model (Heitjan and Little 1991; Schenker and Taylor 1996).
## The PMM method ensures that imputed values are plausible; it might be more appropriate than the regression method (which assumes a joint multivariate normal distribution) if the normality assumption is violated (Horton and Lipsitz 2001, p. 246).

## detects multicollinearity
library(mice)
md.pattern(Project_model)

imp1 <- mice(Project_model, seed=123,m=5, meth='pmm')

pred1 <- imp1$pred
imp1$loggedEvents

pred2 <- matrix(rep(0,13*13),13,13)
pred2[lower.tri(pred2)] <- 1
pred2[upper.tri(pred2)] <- 1

imp2 <- mice(Project_model, pred=pred2, seed=123,m=5, meth='pmm')
imp2$loggedEvents

fitm <- with(imp1, glm(ImpfZust ~ age + Abitur + Educational_attainment + Monthly_income + ImpfHistory +  quality_doctor_treantment +Govtrust  + zapaImpf,family=binomial()))
summary(pool(fitm)) %>% kable(caption = "Mice pooling results", format = "html") %>% 
  kable_styling(latex_options = "striped")


## get the imputed datasets
Project_model_impute <- complete(imp2,2)
md.pattern(Project_model_impute)
md.pairs(Project_model_impute)

## new full model for imputed datasets
Model.full.imputed <- glm(ImpfZust ~ age + Abitur + Educational_attainment + Monthly_income + ImpfHistory +  quality_doctor_treantment + Govtrust  + zapaImpf,data = Project_model_impute, family=binomial())
## Model VIF check
performance::check_collinearity(Model.full.imputed)
## Performance comparsion
tab_model(Model.full, Model.full.imputed)
```

## Submodel 1 step 
 
 
```{r,echo = F,message = FALSE, error = FALSE, warning = FALSE}
## fit full model
Model.full2 <- glm(ImpfZust ~ age + Abitur + Educational_attainment + Monthly_income + ImpfHistory  + Govtrust + zapaImpf,data = na.omit(Project_model), family=binomial())
library(MASS)
Model.Step <- Model.full2 %>% stepAIC(trace = FALSE)
 


Model.selection1 <- glm(ImpfZust ~ age + Educational_attainment + quality_doctor_treantment + Govtrust  + zapaImpf,data = na.omit(Project_model), family=binomial())
tab_model(Model.full, Model.selection1)


# tab_model(
#   Full.model, Step.model,
#   pred.labels = c("Intercept", "cd20", "bclx", "cox2","bax", "bcatenin", "pten", "mtap"),
#   title="Odds ratios table (without expression as reference)", 
#   dv.labels = c("Full model with 7 proteins", "Best combination (stepwise)"),
#   string.pred = "Protein",
#   string.ci = "Conf. Int (95%)",
#   string.p = "P-Value")

```


## Submodel 2 best 
 
 
```{r,echo = F,message = FALSE, error = FALSE, warning = FALSE}
## bestglm
## The outcome variable must be named y, no extraneous variables should be present in the dataset.

library(bestglm) 
Project_model.bestglm <- na.omit(Project_model) %>%
  mutate(y = if_else(ImpfZust=="Nein",0,1)) %>%
  dplyr::select(y, age, Abitur, Educational_attainment, Monthly_income, ImpfHistory, quality_doctor_treantment, Govtrust, zapaImpf)
  

Project_model.bestglm <- data.frame(Project_model.bestglm)
# str(Project_model.bestglm)
Best.model.AIC <-
    bestglm(Xy = Project_model.bestglm,
            family = binomial,          # binomial family for logistic
            IC = "AIC",                 # Information criteria for
            method = "exhaustive")

Model.selection2 <- glm(ImpfZust ~ age + Educational_attainment + ImpfHistory + quality_doctor_treantment + Govtrust,data = na.omit(Project_model), family=binomial())
tab_model(Model.full, Model.selection2)
```


## Submodel 3 ElasticNet penalized regression
 
 
```{r,echo = F,message = FALSE, error = FALSE, warning = FALSE}

# Metrics("Best Model (BIC)", Best.model.BIC$BestModel)
library(glmnet)
x <- as.matrix(Project_model.bestglm %>% dplyr::select(-y) %>% mutate_if(is.factor,as.numeric))
y <- Project_model.bestglm$y
## Set the value of measure to the area under the curve (auc) and use 5-fold cross-validation
set.seed(3)
fitCV <- cv.glmnet(x, y, family = "binomial",
                   type.measure = "auc",
                   nfolds = 5)
# fitCV$lambda.1se
coef <- coef(fitCV, s = "lambda.1se") 

Model.selection3 <- glm(ImpfZust ~ age + Govtrust + zapaImpf,  data = na.omit(Project_model), family=binomial())
tab_model(Model.full, Model.selection3)
```

## Metrics

  
```{r,echo = F,message = FALSE, error = FALSE, warning = FALSE}
## Metrics function
Metrics <- function(modelname, model){
  cbind(Model=modelname,
        glance(model) %>% dplyr::select(logLik, AIC, BIC, df.residual),
        Tjur_R2=round(performance::r2_tjur(model),3))
}

Model_summery_best <- rbind(Metrics("Full model", Model.full),
                            Metrics("Full model imputed", Model.full.imputed), 
      Metrics("Best Model 1", Model.selection1),
      Metrics("Best Model 2", Model.selection2),
      Metrics("Best Model 3", Model.selection3)) 

rownames(Model_summery_best) <- NULL
Model_summery_best %>%
  kable(caption = "Results of models compason", format = "html") %>%
  kable_styling(latex_options = "striped")

```

 

